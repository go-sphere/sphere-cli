{{ define "entmapper" }}
// Code generated by sphere-cli. DO NOT EDIT.
package {{ .GoPackageName }}

{{ $imports := .ImportSpecs -}}
{{- if gt (len $imports) 0 }}
import (
{{- range $imports }}
	{{- if .Alias }}
	{{ .Alias }} "{{ .Path }}"
	{{- else }}
	"{{ .Path }}"
	{{- end }}
{{- end }}
)
{{- end }}

{{ template "enums" . }}

{{ template "to_proto_func" . }}

{{ template "to_proto_list_func" . }}

{{ template "to_ent_func" . }}

{{ end }}

{{ define "to_ent_func" }}
{{ $builderType := printf "%sCreate" .EntType.Name }}
func ToEnt{{ .EntType.Name }}({{ camel .EntType.Name }} *{{ pbIdent .EntType.Name }}, m *{{ ident (.EntPackage.Ident $builderType) }}) error {
	if {{ camel .EntType.Name }} == nil {
		return {{ qualify "fmt" "Errorf" }}("entproto: nil {{ .EntType.Name }} payload")
	}
	{{- template "mutate_helper" dict "Method" (dict "GoName" "Create") "G" . }}
	return nil
}
{{ end }}

{{ define "enums" }}
	{{ $root := . }}
	{{ range .FieldMap.Enums }}
		{{ $enumType := .PbFieldDescriptor.GetEnumType }}
		{{ $enumName := print $root.EntType.Name "_" $enumType.GetName }}
		{{ $pbEnumIdent := $root.GoImportPath.Ident $enumName   }}
		{{ $entLcase := camel $root.EntType.Name }}
		{{ $entEnumIdent := entIdent $entLcase .PbStructField }}
		{{ $enumFieldPrefix := snake $enumType.GetName | upper | printf "%s_" }}
		{{ $omitPrefix := .EntField.Annotations.ProtoEnum.OmitFieldPrefix }}
		var protoIdentNormalizeRegexp{{ $pbEnumIdent.GoName }} = {{ qualify "regexp" "MustCompile" }}(`[^a-zA-Z0-9_]+`)
		func protoIdentNormalize{{ $pbEnumIdent.GoName }}(e string) string {
			return protoIdentNormalizeRegexp{{ $pbEnumIdent.GoName }}.ReplaceAllString(e, "_")
		}

		func toProto{{ $pbEnumIdent.GoName }} (e {{ ident $entEnumIdent }}) {{ pbIdent $pbEnumIdent.GoName }} {
			if v, ok := {{ pbIdent $pbEnumIdent.GoName }}_value[{{ qualify "strings" "ToUpper" }}({{ if not $omitPrefix }}"{{ $enumFieldPrefix }}" + {{ end }}protoIdentNormalize{{ $pbEnumIdent.GoName }}(string(e)))]; ok {
				return {{ pbIdent $pbEnumIdent.GoName }}(v)
			}
			return {{ pbIdent $pbEnumIdent.GoName }}(0)
		}

		func toEnt{{ $pbEnumIdent.GoName }}(e {{ pbIdent $pbEnumIdent.GoName }}) {{ ident $entEnumIdent  }} {
			if v, ok := {{ pbIdent $pbEnumIdent.GoName }}_name[int32(e)]; ok {
				entVal := map[string]string{
				{{- range .EntField.Enums }}
					"{{ if not $omitPrefix }}{{ $enumFieldPrefix }}{{ end }}{{ protoIdentNormalize .Value }}": "{{ .Value }}",
				{{- end }}
				}[v]
				return {{ ident $entEnumIdent }}(entVal)
			}
			return ""
		}
	{{ end}}
{{ end }}

{{ define "to_proto_func" }}
	func ToProto{{ .EntType.Name }}(e *{{ .EntPackage.Ident .EntType.Name | ident }}) (*{{ pbIdent .EntType.Name }}, error) {
		if e == nil {
			return nil, {{ qualify "fmt" "Errorf" }}("entproto: nil {{ .EntType.Name }} entity")
		}
		v := &{{ pbIdent .EntType.Name }}{}
		{{- range .FieldMap.Fields }}
            {{ $varName := .EntField.BuilderField -}}
            {{ $f := print "e." .EntField.StructField -}}
			{{- if .EntField.Nillable }}
				if {{ $f }} != nil {
                {{ $f = print "*" $f -}}
			{{- end }}
			{{- template "field_to_proto" dict "Field" . "VarName" $varName "Ident" $f }}
			v.{{ .PbStructField }} = {{ $varName }}
			{{- if .EntField.Nillable }}
				}
			{{- end }}
		{{- end }}
		{{- range .FieldMap.Edges }}
            {{ $varName := camel .EntEdge.Type.ID.StructField -}}
            {{ $id := print "edg." .EntEdge.Type.ID.StructField -}}
            {{ $name := .EntEdge.StructField -}}
			{{- if .EntEdge.Unique }}
				if edg := e.Edges.{{ $name }}; edg != nil {
					{{- template "field_to_proto" dict "Field" . "VarName" $varName "Ident" $id }}
					v.{{ .PbStructField }} = &{{ pbIdent .EntEdge.Type.Name }}{
						{{ .EdgeIDPbStructField }}: {{ $varName }},
					}
				}
			{{- else }}
				for _, edg := range e.Edges.{{ $name }} {
					{{- template "field_to_proto" dict "Field" . "VarName" $varName "Ident" $id }}
					v.{{ .PbStructField }} = append(v.{{ .PbStructField }}, &{{ pbIdent .EntEdge.Type.Name }}{
						{{ .EdgeIDPbStructField }}: {{ $varName }},
					})
				}
			{{- end }}
		{{- end }}
		return v, nil
	}
{{ end }}

{{ define "to_proto_list_func" }}
	func ToProto{{ .EntType.Name }}List(e []*{{ .EntPackage.Ident .EntType.Name | ident }}) ([]*{{ pbIdent .EntType.Name }}, error) {
		var pbList []*{{ pbIdent .EntType.Name }}
		for _, entEntity := range e {
			pbEntity, err := ToProto{{ .EntType.Name }}(entEntity)
			if err != nil {
				return nil, {{ qualify "fmt" "Errorf" }}("entproto: convert {{ .EntType.Name }} list: %w", err)
			}
			pbList = append(pbList, pbEntity)
		}
		return pbList, nil
	}
{{ end }}

{{ define "field_to_proto" }}
    {{ $id := .Ident -}}
    {{ $conv := newConverter .Field -}}
	{{- if $conv.ToProtoConversion }}
        {{ $id = print $conv.ToProtoConversion "(" $id ")" -}}
	{{- end }}
	{{- if $conv.ToEntMarshallerConstructor.GoName }}
		{{ .VarName }}, err := {{ $id }}.MarshalBinary()
		if err != nil {
			return nil, err
		}
	{{- else if and $conv.ToProtoValuer $conv.ToProtoConstructor.GoName }}
		{{ .VarName }}Value, err := {{$id}}.Value()
		if err != nil {
			return nil, err
		}
		{{ .VarName }}Typed, ok := {{ .VarName }}Value.({{ $conv.ToProtoValuer }})
		if !ok {
			return nil, {{ qualify "errors" "New" }}("casting value to {{ $conv.ToProtoValuer }}")
		}
		{{ .VarName}} := {{ ident $conv.ToProtoConstructor }}({{ .VarName}}Typed)
	{{- else if $conv.ToProtoValuer }}
		{{ .VarName }}Value, err := {{ $id }}.Value()
		if err != nil {
			return nil, err
		}
		{{ .VarName }}, ok := {{ .VarName }}Value.({{ $conv.ToProtoValuer }})
		if !ok {
			return nil, {{ qualify "errors" "New" }}("casting value to {{ $conv.ToProtoValuer }}")
		}
	{{- else if $conv.ToProtoConstructor.GoName }}
		{{ .VarName }} := {{ ident $conv.ToProtoConstructor }}({{ $id }})
	{{- else }}
		{{ .VarName }} := {{ $id }}
	{{- end }}
{{- end }}

{{ define "field_to_ent" }}
    {{ $id := .Ident -}}
    {{ $conv := newConverter .Field -}}
    {{ if $conv.ToEntModifier -}}
        {{ $id = print $id $conv.ToEntModifier -}}
    {{ end -}}
	{{- if $conv.ToEntMarshallerConstructor.GoName }}
		var {{ .VarName }} {{ ident $conv.ToEntMarshallerConstructor}}
		if err := (&{{ .VarName }}).UnmarshalBinary( {{ $id }}); err != nil {
			return {{ qualify "fmt" "Errorf" }}("entproto: failed to unmarshal field %q: %w", "{{ .Field.PbStructField }}", err)
		}
	{{- else if $conv.ToEntScannerConstructor.GoName }}
		{{ .VarName }} := {{ ident $conv.ToEntScannerConstructor }}{}
		if err := (&{{ .VarName }}).Scan( {{ $id }} ); err != nil {
			return {{ qualify "fmt" "Errorf" }}("entproto: failed to scan field %q: %w", "{{ .Field.PbStructField }}", err)
		}
	{{- else if $conv.ToEntConstructor.GoName }}
		{{ .VarName }} := {{ ident $conv.ToEntConstructor }}({{ $id }})
	{{- else if $conv.ToEntConversion }}
		{{ .VarName }} := {{ $conv.ToEntConversion }}({{ $id }})
	{{- else }}
		{{ .VarName }} := {{ $id }}
	{{- end }}
{{- end }}

{{ define "mutate_helper" }}
    {{ $methodName := .Method.GoName -}}
    {{ $reqVar := camel .G.EntType.Name -}}
	{{- range .G.FieldMap.Fields }}
        {{ $skipImmutable := and ( eq $methodName "Update" ) .EntField.Immutable -}}
        {{ $skip := or .IsIDField $skipImmutable -}}
		{{- if not $skip }}
            {{ $varName := camel (print $reqVar  "_"  .EntField.Name) -}}
            {{ $id := print $reqVar ".Get" .PbStructField "()"  -}}
			{{- if .EntField.Optional }}
				if {{ $id }} != nil {
			{{- end }}
			{{- template "field_to_ent" dict "Field" . "VarName" $varName "Ident" $id }}
			m.Set{{ .EntField.StructField }}({{ $varName }})
			{{- if .EntField.Optional }}
			}
			{{- end }}
		{{- end }}
	{{- end }}
	{{- range .G.FieldMap.Edges }}
		{{- if .EntEdge.Unique }}
            {{ $varName := camel (printf "%s_%s" $reqVar .EntEdge.Name) -}}
			{{- $id := printf "%s.Get%s().Get%s()" $reqVar .PbStructField .EdgeIDPbStructField  }}
			{{- $other := printf "%s.Get%s()" $reqVar .PbStructField }}
			if {{ $other }} != nil {
				{{- template "field_to_ent" dict "Field" . "VarName" $varName "Ident" $id }}
				m.Set{{ .EntEdge.StructField }}ID({{ $varName }})
			}
		{{- else }}
			for _, item := range {{ $reqVar }}.Get{{ .PbStructField }}() {
				{{- $varName  := camel .EntEdge.StructField }}
				{{- $id := printf "item.Get%s()" .EdgeIDPbStructField }}
				{{- template "field_to_ent" dict "Field" . "VarName" $varName "Ident" $id }}
				m.Add{{ singular .EntEdge.StructField }}IDs({{ $varName }})
			}
		{{- end }}
	{{- end }}
{{ end }}
